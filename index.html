<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <title>DDBP</title>
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f2f4f8;
      height: 100%;
      overflow: hidden;
    }
    .table-container {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ccc;
    }
    thead {
      background-color: #a3c4dc;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      white-space: nowrap;
    }
    th.name, td.name {
      text-align: left;
      white-space: normal;
    }
    .hidden-print {
      display: none;
    }
    tbody tr:hover {
      background-color: #eef4fa;
      cursor: pointer;
    }
    .home-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #a3c4dc;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content h2 {
      margin-bottom: 15px;
      color: #333;
    }
    .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 22px;
      color: #888;
    }
    .modal-close:hover {
      color: #000;
    }
  </style>
</head>
<body>

  <div class="table-container" id="print-area">
    <table>
      <thead>
        <tr>
          <th>SI</th>
          <th class="hidden-print">Timestamp</th>
          <th class="name">à¦¨à¦¾à¦®</th>
          <th class="hidden-print">à¦ªà¦¿à¦¤à¦¾à¦° à¦¨à¦¾à¦®</th>
          <th>Tk</th>
        </tr>
      </thead>
      <tbody id="data-body"></tbody>
    </table>
  </div>

  <button class="home-btn" onclick="downloadTableAsPDF()">ðŸ“‚</button>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <h2>Details</h2>
      <p id="modalTimestamp"></p>
      <p id="modalName"></p>
      <p id="modalFather"></p>
      <p id="modalTk"></p>
    </div>
  </div>

  <script>
    const sheetURL = "https://opensheet.elk.sh/1aTSjXaYE7O6N3GteGhEtN_0qW3DGPsJFbFoTmrwoLf0/Form Responses 1";

    const modal = document.getElementById("myModal");
    const modalClose = document.getElementById("modalClose");
    const modalTimestamp = document.getElementById("modalTimestamp");
    const modalName = document.getElementById("modalName");
    const modalFather = document.getElementById("modalFather");
    const modalTk = document.getElementById("modalTk");

    fetch(sheetURL)
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById("data-body");
        let total = 0;
        data.forEach((row, index) => {
          const tr = document.createElement("tr");
          const tdSerial = document.createElement("td");
          tdSerial.textContent = index + 1;
          tr.appendChild(tdSerial);

          const tdTimestamp = document.createElement("td");
          tdTimestamp.textContent = row["Timestamp"] || "";
          tdTimestamp.classList.add("hidden-print");
          tr.appendChild(tdTimestamp);

          const tdName = document.createElement("td");
          tdName.textContent = row["Name"] || "";
          tdName.classList.add("name");
          tr.appendChild(tdName);

          const tdFather = document.createElement("td");
          const fatherKey = Object.keys(row).find(key => key.toLowerCase().includes("father"));
          tdFather.textContent = fatherKey ? row[fatherKey] : "";
          tdFather.classList.add("hidden-print");
          tr.appendChild(tdFather);

          const tdTk = document.createElement("td");
          tdTk.textContent = row["Tk"] || "";
          tr.appendChild(tdTk);

          total += parseFloat(row["Tk"]) || 0;

          tr.addEventListener("click", () => {
            modalTimestamp.textContent = `à¦¸à¦®à§Ÿà¦ƒ ${row["Timestamp"] || "N/A"}`;
            modalName.textContent = `à¦¨à¦¾à¦®à¦ƒ ${row["Name"] || "N/A"}`;
            modalFather.textContent = `à¦ªà¦¿à¦¤à¦¾à¦° à¦¨à¦¾à¦®à¦ƒ ${fatherKey ? row[fatherKey] : "N/A"}`;
            modalTk.textContent = `à¦Ÿà¦¾à¦•à¦¾: ${row["Tk"] || "N/A"}`;
            modal.style.display = "flex";
          });

          tbody.appendChild(tr);
        });

        const totalRowScreen = createTotalRow(total, true);
        tbody.appendChild(totalRowScreen);

        const totalRowPDF = createTotalRow(total, false);
        totalRowPDF.classList.add("hidden-print");
        totalRowPDF.setAttribute("id", "pdf-total-row");
        tbody.appendChild(totalRowPDF);
      });

    function createTotalRow(total, isScreen) {
      const tr = document.createElement("tr");
      if (isScreen) {
        tr.innerHTML = `<td colspan="2" style="font-weight:bold; text-align:center;">à¦®à§‹à¦Ÿ</td>
                        <td colspan="2" class="hidden-print"></td>
                        <td style="font-weight:bold; color:green;">${total.toFixed(2)} à§³</td>`;
      } else {
        tr.innerHTML = `<td colspan="4" style="font-weight:bold; text-align:center;">à¦®à§‹à¦Ÿ</td>
                        <td style="font-weight:bold; color:green;">${total.toFixed(2)} à§³</td>`;
      }
      return tr;
    }

    modalClose.onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

    function downloadTableAsPDF() {
      const hidden = document.querySelectorAll('.hidden-print');
      hidden.forEach(el => el.classList.remove('hidden-print'));

      const totalRowScreen = document.querySelector("tbody tr:nth-last-child(2)");
      if (totalRowScreen) totalRowScreen.style.display = "none";

      const totalRowPDF = document.getElementById("pdf-total-row");
      if (totalRowPDF) {
        totalRowPDF.classList.remove('hidden-print');
        totalRowPDF.style.display = "";
      }

      const opt = {
        margin: 0.2,
        filename: 'table-data.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(document.getElementById("print-area")).save().then(() => {
        hidden.forEach(el => el.classList.add('hidden-print'));

        if (totalRowScreen) totalRowScreen.style.display = "";
        if (totalRowPDF) {
          totalRowPDF.classList.add('hidden-print');
          totalRowPDF.style.display = "none";
        }
      });
    }

    const emojis = ["ðŸš€", "â­", "ðŸ”¥", "ðŸ’°", "ðŸ”‘", "â˜¢ï¸", "â™¥ï¸", "ðŸ’¥"];
    let index = 0;

    const setFaviconEmoji = emoji => {
      const canvas = document.createElement("canvas");
      canvas.width = 64; canvas.height = 64;
      const ctx = canvas.getContext("2d");
      ctx.font = "50px serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(emoji, 32, 32);

      let link = document.getElementById("favicon");
      if (!link) {
        link = document.createElement("link");
        link.id = "favicon";
        link.rel = "icon";
        link.type = "image/png";
        document.head.appendChild(link);
      }
      link.href = canvas.toDataURL("image/png");
    };

    window.addEventListener("DOMContentLoaded", () => {
      setFaviconEmoji(emojis[index]);
      setInterval(() => {
        index = (index + 1) % emojis.length;
        setFaviconEmoji(emojis[index]);
      }, 2000);
    });
  </script>

</body>
</html>
